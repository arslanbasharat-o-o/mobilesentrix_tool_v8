<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MobileSentrix Extractor — v8</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --bg: #050614;
      --page-bg:
        radial-gradient(1400px 900px at -10% 25%, rgba(102, 240, 255, 0.18), transparent 60%),
        radial-gradient(1200px 780px at 115% 10%, rgba(134, 107, 255, 0.24), transparent 65%),
        radial-gradient(900px 720px at 55% 120%, rgba(82, 224, 165, 0.18), transparent 70%),
        linear-gradient(200deg, #050614 0%, #071226 45%, #041d33 100%);
      --panel: rgba(12, 17, 33, 0.8);
      --panel-solid: #101730;
      --text: #e8ecff;
      --muted: #96a2c3;
      --primary: #66f0ff;
      --primary-2: #866bff;
      --accent: #52e0a5;
      --danger: #ff7676;
      --border: rgba(135, 144, 199, 0.28);
      --grid: rgba(134, 107, 255, 0.09);
      --focus: rgba(102, 240, 255, 0.32);
      --url: #87c5ff;
      --table-stripe: rgba(20, 29, 54, 0.65);
      --header-bg: rgba(8, 12, 28, 0.92);
      --shadow: 0 25px 60px rgba(3, 10, 32, 0.55);
    }
    [data-bs-theme="light"] {
      --bg: #f4f6ff;
      --page-bg:
        radial-gradient(1400px 900px at -8% 18%, rgba(116, 160, 255, 0.26), transparent 58%),
        radial-gradient(1100px 820px at 102% 6%, rgba(98, 245, 255, 0.22), transparent 60%),
        radial-gradient(950px 760px at 50% 118%, rgba(157, 227, 255, 0.22), transparent 72%),
        linear-gradient(195deg, #eef3ff 0%, #f9fcff 58%, #edf3ff 100%);
      --panel: rgba(255, 255, 255, 0.9);
      --panel-solid: #ffffff;
      --text: #0e1230;
      --muted: #5c6585;
      --primary: #2c6dff;
      --primary-2: #8361ff;
      --accent: #139f6d;
      --danger: #e25b5b;
      --border: rgba(42, 58, 133, 0.16);
      --grid: rgba(76, 96, 255, 0.07);
      --focus: rgba(44, 109, 255, 0.25);
      --url: #1f54ff;
      --table-stripe: rgba(232, 235, 255, 0.7);
      --header-bg: rgba(236, 240, 255, 0.88);
      --shadow: 0 18px 50px rgba(38, 48, 94, 0.1);
    }
    html, body { height: 100%; }
    body {
      font-family: 'Plus Jakarta Sans', 'Segoe UI', sans-serif;
      background: var(--page-bg);
      background-color: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }
    .grid-bg::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: 0;
      background-image:
        linear-gradient(var(--grid) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid) 1px, transparent 1px);
      background-size: 30px 30px, 30px 30px;
      mask-image: radial-gradient(circle at 50% 50%, black 0%, transparent 75%);
      animation: drift 32s linear infinite;
      pointer-events: none;
    }
    .grid-bg::after {
      content: "";
      position: fixed;
      inset: -20% -10% 0;
      z-index: -1;
      background:
        radial-gradient(420px 420px at 18% 22%, rgba(102, 240, 255, 0.24), transparent 65%),
        radial-gradient(560px 520px at 82% 18%, rgba(134, 107, 255, 0.28), transparent 70%),
        radial-gradient(520px 520px at 60% 85%, rgba(82, 224, 165, 0.24), transparent 70%);
      filter: blur(80px);
      opacity: 0.55;
      animation: aurora-shift 26s ease-in-out infinite alternate;
      pointer-events: none;
    }
    @keyframes drift { from { transform: translateY(0); } to { transform: translateY(30px); } }
    @keyframes aurora-shift {
      0% { transform: translate3d(-4%, -2%, 0) scale(1); opacity: 0.45; }
      50% { transform: translate3d(3%, 1%, 0) scale(1.05); opacity: 0.6; }
      100% { transform: translate3d(-2%, 4%, 0) scale(0.97); opacity: 0.48; }
    }
    .page-shell { position: relative; z-index: 1; max-width: 1240px; margin: 0 auto; }
    .cy-card {
      position: relative;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 24px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
    }
    [data-bs-theme="light"] .cy-card { backdrop-filter: blur(12px); }
    .top-bar {
      position: relative;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1.75rem;
      padding:1.5rem 1.9rem;
      overflow:hidden;
    }
    .top-bar::before,
    .top-bar::after {
      content:"";
      position:absolute;
      inset:0;
      z-index:0;
      pointer-events:none;
    }
    .top-bar::before {
      background: linear-gradient(135deg, rgba(134,107,255,0.22), rgba(102,240,255,0.18));
      opacity:0.9;
    }
    .top-bar::after {
      background: radial-gradient(circle at 20% -20%, rgba(255,255,255,0.35), transparent 55%);
      mix-blend-mode: screen;
      opacity:0.4;
    }
    [data-bs-theme="light"] .top-bar::before {
      background: linear-gradient(135deg, rgba(88,118,255,0.18), rgba(44,109,255,0.12));
    }
    [data-bs-theme="light"] .top-bar::after {
      opacity:0.25;
    }
    .top-bar > * { position:relative; z-index:1; }
    .header-main { display:flex; align-items:flex-end; gap:1rem; flex-wrap:wrap; }
    .header-title {
      margin:0;
      font-size:1.95rem;
      font-weight:800;
      letter-spacing:0.08rem;
      text-transform:none;
      color: var(--text);
      line-height:1.1;
    }
    .header-subtitle { margin:0; color: var(--muted); font-size:0.9rem; font-weight:600; opacity:0.85; }
    .version-pill {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0.28rem 0.85rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.24);
      background: rgba(255,255,255,0.12);
      font-weight:700;
      letter-spacing:0.16rem;
      text-transform:uppercase;
      font-size:0.7rem;
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(102,240,255,0.25);
    }
    [data-bs-theme="light"] .version-pill {
      background: rgba(255,255,255,0.75);
      border-color: rgba(44,109,255,0.18);
      box-shadow: inset 0 0 0 1px rgba(44,109,255,0.12);
      color: var(--primary);
    }
    .switch-wrap {
      display:flex;
      align-items:center;
      gap:.6rem;
      color: var(--muted);
      padding:0.35rem 0.75rem;
      border-radius:999px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(12px);
    }
    [data-bs-theme="light"] .switch-wrap {
      background: rgba(44,109,255,0.08);
      border:1px solid rgba(44,109,255,0.18);
      color: var(--text);
    }
    .form-label { color: var(--muted); font-weight:700; text-transform:uppercase; font-size:.7rem; letter-spacing:.12rem; }
    .form-control, .form-select, textarea {
      background: rgba(255,255,255,0.04);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 0.6rem 0.75rem;
    }
    [data-bs-theme="light"] .form-control,
    [data-bs-theme="light"] .form-select,
    [data-bs-theme="light"] textarea {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(42,58,133,0.16);
    }
    .form-control:focus, .form-select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 .25rem var(--focus); }
    textarea { min-height: 120px; }
    .fieldset-grid { display:grid; gap:0.75rem; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .controls-grid { align-items:start; }
    .control-span { grid-column: 1 / -1; }
    .fieldset-card {
      position: relative;
      background: var(--panel-solid);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      padding:0.85rem;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
    }
    [data-bs-theme="light"] .fieldset-card {
      background: rgba(255,255,255,0.96);
      border-color: rgba(42,58,133,0.12);
      box-shadow: inset 0 0 0 1px rgba(42,58,133,0.05);
    }
    .fieldset-title { display:block; font-size:0.7rem; text-transform:uppercase; letter-spacing:0.15rem; font-weight:700; color: var(--muted); margin-bottom:0.5rem; }
    .fieldset-subtitle { margin:-0.25rem 0 0.7rem; color: var(--muted); max-width:36rem; font-size:0.84rem; }
    .option-stack { display:flex; flex-direction:column; gap:0.5rem; }
    .watchlist-count { display:flex; align-items:center; gap:0.35rem; color: var(--muted); font-size:0.82rem; text-transform:uppercase; letter-spacing:0.1rem; }
    .watchlist-count strong { color: var(--text); font-size:1rem; }
    .search-grid .fieldset-card { display:flex; flex-direction:column; }
    .search-grid .btn { margin-top:auto; }
    .control-section { display:flex; flex-direction:column; gap:0.75rem; padding:0; }
    .control-section .section-heading { align-items:center; margin-bottom:0; }
    .control-section .action-bar { margin-top:0 !important; }
    .control-section .hint { margin-top:0.25rem !important; }
    .url-card textarea { min-height: 88px; }
    .section-heading { display:flex; align-items:flex-start; justify-content:space-between; gap:1rem; margin-bottom:0.9rem; }
    .results-head { display:flex; align-items:flex-start; justify-content:space-between; gap:1.5rem; flex-wrap:wrap; }
    .results-title { flex:1 1 260px; }
    .results-toolbar { display:flex; align-items:flex-start; justify-content:flex-end; gap:0.65rem; flex-wrap:wrap; min-width:240px; }
    .chip-scroll { display:flex; align-items:center; gap:0.45rem; flex-wrap:wrap; max-width:100%; flex:1 1 auto; }
    .chip-scroll[hidden] { display:none; }
    .page-size-pill { position: relative; display:inline-flex; align-items:center; }
    .page-size-pill select {
      appearance:none;
      padding: 0.5rem 2.2rem 0.5rem 0.9rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.12);
      color: var(--text);
      font-weight:600;
      letter-spacing:0.05rem;
      backdrop-filter: blur(12px);
      transition:border 0.2s ease, box-shadow 0.2s ease;
    }
    .page-size-pill select:focus { outline:none; border-color: var(--primary); box-shadow:0 0 0 3px rgba(102,240,255,0.18); }
    [data-bs-theme="light"] .page-size-pill select { background: rgba(255,255,255,0.92); border-color: rgba(42,58,133,0.16); }
    .page-size-pill::after { content:'▾'; position:absolute; right:0.85rem; font-size:0.65rem; color:var(--muted); pointer-events:none; }
    .page-size-label { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip: rect(0,0,0,0); border:0; }
    .section-title { margin:0; font-weight:700; font-size:1.1rem; letter-spacing:0.12rem; text-transform:uppercase; color: var(--muted); }
    .section-subtitle { margin:0.35rem 0 0; color: var(--text); opacity:0.68; max-width:32rem; font-size:0.9rem; }
    .section-toggle { display:flex; align-items:center; margin-left:auto; padding-left:0.5rem; }
    .section-toggle .switch-wrap { margin-left:auto; }
    .fieldset-card .row { --bs-gutter-x: 0.75rem; --bs-gutter-y: 0.6rem; }
    .fieldset-card .form-check { margin-bottom:0.2rem; }
    .fieldset-card .option-stack { gap:0.4rem; }
    .btn-cy { border-radius:12px; font-weight:700; letter-spacing:.14rem; text-transform:uppercase; border:1px solid transparent; padding:0.6rem 1.25rem; transition: transform .18s ease, box-shadow .18s ease; }
    .btn-primary.btn-cy { background-image: linear-gradient(100deg, var(--primary), var(--primary-2)); color:#03121c; box-shadow:0 10px 30px rgba(102,240,255,0.28); }
    .btn-primary.btn-cy:hover { transform: translateY(-2px); box-shadow:0 12px 34px rgba(120,120,255,0.35); }
    .btn-ghost { background: rgba(255,255,255,0.03); color:var(--text); border:1px solid rgba(255,255,255,0.14); }
    .btn-ghost:hover { border-color: var(--primary); color: var(--primary); box-shadow:0 10px 20px rgba(102,240,255,0.18); }
    [data-bs-theme="light"] .btn-ghost { background: rgba(255,255,255,0.95); border:1px solid rgba(42,58,133,0.18); color: var(--text); }
    .btn-ghost.danger {
      color: var(--danger);
      border-color: rgba(255,118,118,0.32);
      background: rgba(255,118,118,0.08);
    }
    .btn-ghost.danger:hover {
      color: var(--danger);
      border-color: rgba(255,118,118,0.5);
      box-shadow: 0 12px 26px rgba(255,118,118,0.25);
      background: rgba(255,118,118,0.14);
    }
    .badge-cy { background: linear-gradient(90deg, rgba(102,240,255,.18), rgba(134,107,255,.18)); border:1px solid rgba(255,255,255,0.16); color: var(--text); font-weight:700; border-radius:999px; padding:0.25rem 0.75rem; font-size:0.75rem; }
    .action-bar { display:flex; flex-wrap:wrap; align-items:center; gap:0.55rem; }
    .action-bar .badge-cy { margin-left:auto; }
    .sticky-header thead th { position: sticky; top: 0; z-index: 2; background: linear-gradient(180deg, var(--header-bg), transparent); border-bottom: 1px solid var(--border) !important; text-transform: uppercase; font-size: .72rem; letter-spacing: .1rem; color: var(--muted); }
    table.table { color: var(--text); }
    .results-card { padding: 2rem 2rem 2.2rem; overflow: hidden; }
    .results-card .table-heading { padding: 0; margin-bottom: 1rem; }
    .results-head { display:flex; align-items:flex-start; justify-content:space-between; gap:1.5rem; flex-wrap:wrap; }
    .results-title { flex:1 1 260px; }
    .results-toolbar { display:flex; align-items:flex-end; justify-content:flex-end; gap:0.65rem; flex-wrap:wrap; min-width:240px; }
    .page-size-pill { position: relative; display:inline-flex; align-items:center; }
    .page-size-pill select {
      appearance:none;
      padding: 0.5rem 2.2rem 0.5rem 0.9rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.12);
      color: var(--text);
      font-weight:600;
      letter-spacing:0.05rem;
      backdrop-filter: blur(12px);
      transition:border 0.2s ease, box-shadow 0.2s ease;
    }
    .page-size-pill select:focus { outline:none; border-color: var(--primary); box-shadow:0 0 0 3px rgba(102,240,255,0.18); }
    [data-bs-theme="light"] .page-size-pill select { background: rgba(255,255,255,0.92); border-color: rgba(42,58,133,0.16); }
    .page-size-pill::after { content:'▾'; position:absolute; right:0.85rem; font-size:0.65rem; color:var(--muted); pointer-events:none; }
    .page-size-label { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    .context-chip {
      display:inline-flex;
      align-items:center;
      gap:0.45rem;
      padding:0.32rem 0.7rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.28);
      background: rgba(255,255,255,0.78);
      color: var(--text);
      font-weight:600;
      font-size:0.82rem;
      line-height:1.2;
      min-height:36px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .context-chip:focus-visible { outline:2px solid var(--primary); outline-offset:2px; }
    .context-chip:hover { transform: translateY(-1px); box-shadow:0 8px 18px rgba(4,14,32,0.18); }
    [data-bs-theme="light"] .context-chip { border-color: rgba(42,58,133,0.16); background: rgba(255,255,255,0.94); }
    [data-bs-theme="dark"] .context-chip { border-color: rgba(132,148,210,0.32); background: rgba(20,32,58,0.6); }
    .context-chip__badge {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0.1rem 0.45rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.34);
      font-size:0.7rem;
      letter-spacing:0.08rem;
      text-transform:uppercase;
      opacity:0.85;
    }
    [data-bs-theme="light"] .context-chip__badge { border-color: rgba(42,58,133,0.2); }
    .context-chip--more { opacity:0.8; font-weight:600; }
    .context-chip--more { cursor: default; }
    .results-shell {
      position: relative;
      margin-top: 0.6rem;
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 55%) var(--panel);
      box-shadow: 0 25px 60px rgba(4, 10, 30, 0.18), inset 0 0 0 1px rgba(255,255,255,0.05);
      backdrop-filter: blur(20px);
      overflow: hidden;
    }
    [data-bs-theme="light"] .results-shell {
      border-color: rgba(42,58,133,0.12);
      background: linear-gradient(180deg, rgba(255,255,255,0.92) 0%, rgba(248,250,255,0.78) 55%);
      box-shadow: 0 24px 60px rgba(38, 48, 94, 0.1), inset 0 0 0 1px rgba(42,58,133,0.08);
    }
    .results-shell::before {
      content: "";
      position: absolute;
      top: -30%;
      left: 20%;
      width: 60%;
      height: 60%;
      background: radial-gradient(circle at center, rgba(102,240,255,0.35), transparent 65%);
      opacity: 0.3;
      pointer-events: none;
    }
    .results-table { position: relative; overflow-x: auto; padding: 0 1.75rem 1.75rem; }
    .results-table table { width: 100%; border-collapse: separate; border-spacing: 0; color: var(--text); }
    .results-table thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(10,22,45,0.55);
      backdrop-filter: blur(14px);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .12rem;
      font-size: .72rem;
      padding: 0.85rem 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    [data-bs-theme="light"] .results-table thead th {
      background: rgba(246,248,255,0.92);
      border-bottom: 1px solid rgba(42,58,133,0.12);
    }
    .results-table tbody td {
      padding: 0.9rem 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      transition: background 0.15s ease, transform 0.15s ease;
    }
    [data-bs-theme="light"] .results-table tbody td { border-bottom: 1px solid rgba(42,58,133,0.08); }
    .results-table tbody tr:nth-child(odd) td { background: rgba(255,255,255,0.02); }
    [data-bs-theme="light"] .results-table tbody tr:nth-child(odd) td { background: rgba(238,242,255,0.7); }
    .results-table tbody tr:hover td {
      background: rgba(102,240,255,0.08);
      transform: translateY(-1px);
    }
    .results-table tbody tr:last-child td { border-bottom: none; }
    .results-table.fade-in tbody tr { opacity: 0; animation: resultsFade .28s ease forwards; }
    .results-table.fade-in tbody tr:nth-child(odd) { animation-delay: .02s; }
    @keyframes resultsFade { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    .table-img { width:44px;height:44px;border-radius:12px;object-fit:cover;border:1px solid rgba(255,255,255,0.14); background:#0a0a0a; box-shadow: 0 6px 18px rgba(0,0,0,0.25); }
    [data-bs-theme="light"] .table-img { border-color: rgba(42,58,133,0.18); background:#f3f5ff; }
    .results-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1.2rem;
      padding: 3.4rem 1.5rem 3rem;
      text-align: center;
      color: var(--muted);
    }
    .results-empty .empty-glow {
      width: 90px;
      height: 90px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(102,240,255,0.75), rgba(134,107,255,0.65));
      filter: blur(0.2px);
      opacity: 0.85;
    }
    .results-empty h3 { margin: 0; font-size: 1.05rem; font-weight: 700; color: var(--text); }
    .results-empty p { margin: 0; font-size: 0.9rem; }
    .results-footer {
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap:0.9rem;
      padding: 0 1.75rem 1.4rem;
      flex-wrap: wrap;
    }
    .results-footer__actions { display: inline-flex; gap: 0.6rem; }
    .results-footer button {
      padding: 0.55rem 1.05rem;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      font-weight: 600;
      letter-spacing: 0.05rem;
    }
    [data-bs-theme="light"] .results-footer button { border-color: rgba(42,58,133,0.18); background: rgba(255,255,255,0.85); }
    .results-footer button:disabled { opacity:0.45; cursor: not-allowed; }
    .results-footer .page-info { font-size: 0.85rem; color: var(--muted); letter-spacing: 0.05rem; }
    .url-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      padding: 0.35rem 0.85rem;
      border-radius: 999px;
      border: 1px solid rgba(102, 240, 255, 0.35);
      background: rgba(102, 240, 255, 0.12);
      color: var(--text);
      font-size: 0.75rem;
      text-transform: uppercase;
      text-decoration: none;
      font-weight: 600;
      letter-spacing: 0.05rem;
      white-space: nowrap;
    }
    .url-link:hover { background: rgba(102, 240, 255, 0.22); border-color: rgba(102, 240, 255, 0.5); }
    [data-bs-theme="light"] .url-link {
      background: rgba(44, 109, 255, 0.12);
      border-color: rgba(44, 109, 255, 0.24);
      color: var(--primary);
    }
    [data-bs-theme="light"] .url-link:hover { background: rgba(44, 109, 255, 0.22); border-color: rgba(44, 109, 255, 0.32); }
    .source-chip {
      display: inline-flex;
      align-items: center;
      padding: 0.28rem 0.6rem;
      border-radius: 999px;
      font-size: 0.68rem;
      letter-spacing: 0.08rem;
      text-transform: uppercase;
      background: rgba(134, 107, 255, 0.18);
      color: var(--text);
      font-weight: 600;
      border: 1px solid rgba(134, 107, 255, 0.35);
      white-space: nowrap;
    }
    .source-chip[data-short='1'] { letter-spacing: 0.12rem; }
    [data-bs-theme="light"] .source-chip {
      background: rgba(44, 109, 255, 0.18);
      color: var(--primary);
      border-color: rgba(44, 109, 255, 0.32);
    }
    .overlay { position: fixed; inset: 0; background: rgba(5,8,20,.55); backdrop-filter: blur(4px); display: none; align-items:center; justify-content:center; z-index: 9999; }
    .spinner { width: 70px; height: 70px; border-radius: 50%; border: 3px solid rgba(255,255,255,.2); border-top-color: var(--primary); border-right-color: var(--primary-2); animation: spin 1s linear infinite; box-shadow: 0 0 25px var(--primary); }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hint { color: var(--muted); }
    .star { cursor: pointer; user-select: none; }
    @media (max-width: 992px) {
      .section-heading { flex-direction: column; align-items:flex-start; }
      .action-bar { gap:0.5rem; }
    }
    @media (max-width: 768px) {
      .top-bar { flex-direction: column; align-items:flex-start; }
      .header-main { align-items:flex-start; }
      .header-title { font-size: 1.6rem; }
      .section-toggle { width: 100%; }
      .control-section .section-heading { align-items:flex-start; }
      .switch-wrap { align-self: flex-start; }
      .action-bar { flex-direction: column; align-items: stretch; }
      .action-bar .badge-cy { margin-left:0; align-self:flex-start; }
      .table-responsive { padding: 0 1rem 1.5rem; }
      .results-toolbar { justify-content:flex-start; width:100%; }
    }
    @media (max-width: 640px) {
      .results-head { flex-direction: column; align-items:flex-start; gap:0.75rem; }
      .results-toolbar { width: 100%; align-items: stretch; }
      .chip-scroll { flex-wrap: nowrap; overflow-x: auto; padding-bottom: 0.2rem; -webkit-overflow-scrolling: touch; }
      .chip-scroll::-webkit-scrollbar { height: 0; }
      .page-size-pill { width: 100%; }
      .page-size-pill select { width: 100%; }
      .results-footer { flex-direction: column; align-items: stretch; gap: 0.6rem; }
      .results-footer .page-info { text-align: center; width: 100%; }
      .results-footer__actions { width: 100%; justify-content: space-between; }
      .results-footer button { width: 48%; }
    }
  </style>
</head>
<body class="grid-bg">
  <div class="page-shell container-xxl py-4">
    <header class="top-bar cy-card mb-4">
      <div class="header-main">
        <div>
          <h1 class="header-title">MobileSentrix Extractor</h1>
          <p class="header-subtitle">Pricing &amp; watchlist cockpit</p>
        </div>
        <span class="version-pill">v8</span>
      </div>
    </header>

    <!-- Controls -->
    <section class="cy-card p-4 mb-4 control-section">
      <div class="section-heading">
        <div>
          <h2 class="section-title">Fetch Controls</h2>
          <p class="section-subtitle">Paste category or product URLs to fetch pricing, then tune filters before exporting.</p>
        </div>
        <div class="section-toggle">
          <div class="switch-wrap">
            <label class="form-check-label" for="darkMode">Light</label>
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" id="darkMode" checked>
            </div>
            <label class="form-check-label" for="darkMode">Dark</label>
          </div>
        </div>
      </div>
      <div class="controls-grid fieldset-grid">
        <div class="url-card fieldset-card control-span">
          <div class="fieldset-title">Target URLs</div>
          <p class="fieldset-subtitle">Paste category or product URLs (one per line). We crawl pagination automatically up to 20 pages.</p>
          <textarea id="urls" class="form-control" placeholder="https://www.mobilesentrix.ca/...&#10;https://www.mobilesentrix.com/..."></textarea>
        </div>

        <div class="fieldset-card">
          <div class="fieldset-title">Discount Rules</div>
          <div class="row g-3 align-items-end">
            <div class="col-12 col-sm-6">
              <label class="form-label">% Off</label>
              <input id="percent" type="number" class="form-control" min="0" max="95" step="0.1" value="0">
            </div>
            <div class="col-12 col-sm-6">
              <label class="form-label">-$ Off</label>
              <input id="absOff" type="number" class="form-control" min="0" step="0.01" value="0">
            </div>
          </div>
        </div>

        <div class="fieldset-card">
          <div class="fieldset-title">Price Guardrails</div>
          <div class="row g-3 align-items-end">
            <div class="col-12 col-sm-6">
              <label class="form-label">Price Min</label>
              <input id="priceMin" type="number" class="form-control" min="0" step="0.01" placeholder="0">
            </div>
            <div class="col-12 col-sm-6">
              <label class="form-label">Price Max</label>
              <input id="priceMax" type="number" class="form-control" min="0" step="0.01" placeholder="">
            </div>
            <div class="col-12">
              <label class="form-label">Price drop alert %</label>
              <input id="dropPct" type="number" class="form-control" min="1" max="90" step="1" value="10">
            </div>
          </div>
        </div>

        <div class="fieldset-card">
          <div class="fieldset-title">Keyword Filters</div>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Include keywords</label>
              <input id="kwInclude" class="form-control" placeholder="Incell, Refurbished">
            </div>
            <div class="col-12">
              <label class="form-label">Exclude keywords</label>
              <input id="kwExclude" class="form-control" placeholder="With Frame, Grade B">
            </div>
          </div>
        </div>

        <div class="fieldset-card">
          <div class="fieldset-title">Display &amp; Compare</div>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Sort</label>
              <select id="sortBy" class="form-select">
                <option value="none">—</option>
                <option value="final_asc">Final ↑</option>
                <option value="final_desc">Final ↓</option>
                <option value="orig_asc">Original ↑</option>
                <option value="orig_desc">Original ↓</option>
                <option value="disc_asc">Discount % ↑</option>
                <option value="disc_desc">Discount % ↓</option>
                <option value="title_asc">Title A→Z</option>
                <option value="title_desc">Title Z→A</option>
                <option value="source_asc">Source A→Z</option>
                <option value="source_desc">Source Z→A</option>
              </select>
            </div>
            <div class="col-12">
              <div class="option-stack">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="hideDupes">
                  <label class="form-check-label" for="hideDupes">Hide duplicates</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="groupModel">
                  <label class="form-check-label" for="groupModel">Group by model</label>
                </div>
              </div>
            </div>
            <div class="col-12">
              <label class="form-label">Upload CSV (compare)</label>
              <input id="csvUpload" type="file" accept=".csv" class="form-control">
            </div>
          </div>
        </div>
      </div>

      <div class="action-bar mt-2">
        <button id="runBtn" class="btn btn-primary btn-cy">⚡ Fetch</button>
        <button id="csvBtn" class="btn btn-ghost" disabled>Download CSV</button>
        <button id="xlsxBtn" class="btn btn-ghost" disabled>Download XLSX</button>
        <button id="copyBtn" class="btn btn-ghost" disabled>Copy table</button>
        <div id="countBadge" class="badge badge-cy d-none">0 items</div>
      </div>
      <p class="mt-2 mb-0 hint">Tip: use Include/Exclude to instantly filter results. Sorting &amp; filters are client-side (fast).</p>
    </section>

    <div id="alert" class="alert cy-card d-none p-3" role="alert"></div>

    <!-- search + watchlist -->
    <section class="cy-card p-4 mb-4">
      <div class="section-heading">
        <h2 class="section-title">Search &amp; Watchlist</h2>
        <p class="section-subtitle">Refine scraped rows instantly or export your starred items.</p>
      </div>
      <div class="fieldset-grid search-grid">
        <div class="fieldset-card">
          <div class="fieldset-title">Quick Search</div>
          <label class="form-label">Search</label>
          <input id="search" class="form-control" placeholder="Title or URL">
        </div>
        <div class="fieldset-card">
          <div class="fieldset-title">Watchlist Tools</div>
          <div class="option-stack mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="showWatchlistOnly">
              <label class="form-check-label" for="showWatchlistOnly">Show watchlist ★ only</label>
            </div>
            <div class="watchlist-count">
              <span>Tracked:</span>
              <strong id="heroWatchCount">0</strong>
            </div>
          </div>
          <button id="exportWatchlistBtn" class="btn btn-ghost w-100">Export Watchlist</button>
          <button id="clearWatchlistBtn" class="btn btn-ghost danger w-100 mt-2" disabled>Clear Watchlist</button>
        </div>
      </div>
    </section>

    <!-- table -->
    <section class="cy-card results-card">
      <div class="section-heading table-heading results-head">
        <div class="results-title">
          <h2 class="section-title">Results</h2>
          <p class="section-subtitle">Rows update as you tweak filters. Star items to track future drops.</p>
        </div>
        <div class="results-toolbar">
          <nav id="modelChipWrap" class="chip-scroll" aria-label="Current models" hidden></nav>
          <div class="page-size-pill">
            <label for="pageSize" class="page-size-label">Results per page</label>
            <select id="pageSize">
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
        </div>
      </div>
      <div class="results-shell">
        <div class="results-table">
          <table class="table align-middle" id="resultsTable">
            <thead>
              <tr>
                <th>#</th>
                <th>★</th>
                <th>Image</th>
                <th>Title</th>
                <th>Original</th>
                <th>% Off</th>
                <th>-$</th>
                <th>Final</th>
                <th>Δ</th>
                <th>Δ%</th>
                <th>Product URL</th>
                <th>Source</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="results-empty d-none" id="resultsEmpty">
          <div class="empty-glow" aria-hidden="true"></div>
          <h3>No results yet</h3>
          <p>Run a fetch or adjust filters to populate the table.</p>
        </div>
        <div class="results-footer d-none" id="resultsFooter">
          <div class="page-info" id="pageInfo">Page 1 of 1</div>
          <div class="results-footer__actions">
            <button type="button" id="prevPage" disabled>Prev</button>
            <button type="button" id="nextPage" disabled>Next</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- overlay spinner -->
  <div id="overlay" class="overlay"><div class="spinner"></div></div>

  <script>
    
    
    const $ = id => document.getElementById(id);
    const runBtn = $('runBtn'), csvBtn = $('csvBtn'), xlsxBtn = $('xlsxBtn'), copyBtn = $('copyBtn');
    const urlsTA = $('urls'), percentInput = $('percent'), absOffInput = $('absOff');
    const priceMin = $('priceMin'), priceMax = $('priceMax');
    const kwInclude = $('kwInclude'), kwExclude = $('kwExclude');
    const sortBy = $('sortBy'), hideDupes = $('hideDupes'), groupModel = $('groupModel');
    const csvUpload = $('csvUpload'), dropPct = $('dropPct');
    const alertBox = $('alert'), tbody = document.querySelector('#resultsTable tbody');
    const searchInput = $('search'), darkMode = $('darkMode'), overlay = $('overlay');
    const countBadge = $('countBadge'), showWatchlistOnly = $('showWatchlistOnly');
    const exportWatchlistBtn = $('exportWatchlistBtn');
    const clearWatchlistBtn = $('clearWatchlistBtn');
    const resultsEmpty = $('resultsEmpty');
    const resultsFooter = $('resultsFooter');
    const pageSizeSelect = $('pageSize');
    const prevPageBtn = $('prevPage');
    const nextPageBtn = $('nextPage');
    const pageInfo = $('pageInfo');
    const resultsTableContainer = document.querySelector('.results-table');
    const modelChipWrap = $('modelChipWrap');
    const statLastFetch = $('statLastFetch'), statFetched = $('statFetched');
    const statVisible = $('statVisible'), statWatchlist = $('statWatchlist');
    const heroWatchCount = $('heroWatchCount');

    // state
    let rawItems = [];            // server items
    let rows = [];                // rendered/filtered rows
    let compareMap = new Map();   // normalized title -> price
    let lastExportRows = [];      // for CSV/XLSX export
    let currentPage = 1;
    let pageSize = 25;
    let currentModels = [];
    const MODEL_STORAGE_KEY = 'msx_last_models_v1';
    const PAGE_SIZE_KEY = 'msx_page_size_v1';
    const MODEL_SKIP_SEGMENTS = new Set([
      'replacement-parts','parts','apple','samsung','huawei','xiaomi','oneplus','google','lg','sony','nokia','motorola','oppo','vivo','ipad','iphone','watch','macbook','mac','tablet',
      'iphone-parts','ipad-parts','watch-parts','tablet-parts','phone-parts','category','products','product','collections','accessories','accessory','shop','all','index'
    ]);

    (function restorePageSize(){
      const stored = parseInt(localStorage.getItem(PAGE_SIZE_KEY) || '25', 10);
      if([25,50,100].includes(stored)){
        pageSize = stored;
        if(pageSizeSelect) pageSizeSelect.value = String(pageSize);
      } else if(pageSizeSelect){
        pageSizeSelect.value = '25';
      }
    })();

    function setLoading(on){
      overlay.style.display = on ? 'flex' : 'none';
      runBtn.disabled = on;
    }
    function showAlert(type, msg){
      alertBox.className = 'alert cy-card p-3 alert-' + type;
      alertBox.textContent = msg;
      alertBox.classList.remove('d-none');
    }
    function clearAlert(){ alertBox.classList.add('d-none'); }

    // --- utils ---
    const norm = s => (s||'')
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g,' ')
      .replace(/\b(for|with|without|frame|lcd|assembly|screen|display|series|model|global|original|grade|version|and|the|a|an)\b/g,'')
      .replace(/\s+/g,' ')
      .trim();

    function modelKey(title){
      let t = norm(title);
      const m = t.match(/\b([a-z]{1,3}-?\d{1,4}[a-z]?)\b|\b(galaxy|iphone|ipad|a\d{2}|a0?\d{1,2}|xs?max|pro|max|mini|se|plus)\b/g);
      if(m) return m.join(' ');
      return t;
    }

    const escapeHtml = (str = '') => String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');

    function formatSource(site){
      if(!site) return { label: '', title: '' };
      const raw = String(site).trim();
      if(!raw) return { label: '', title: '' };

      let label = raw;
      if(/^https?:\/\//i.test(raw)){
        try {
          const u = new URL(raw);
          label = u.hostname;
        } catch (_) {
          // keep raw fallback
        }
      }

      if(label === raw){
        label = label.replace(/^https?:\/\//i,'');
      }

      label = label.replace(/^www\./i,'');
      if(label.includes('/')) label = label.split('/')[0];
      label = label.trim();

      return { label: label || raw, title: raw };
    }

    function formatModelWord(word){
      const lower = word.toLowerCase();
      if(!lower) return '';
      if(/^[0-9]+$/.test(lower)) return word.toUpperCase();
      if(/^[a-z]?\d+[a-z]?$/i.test(word)) return word.toUpperCase();
      const upperTokens = ['se','tv','lte','5g','usb'];
      if(upperTokens.includes(lower)) return lower.toUpperCase();
      if(lower === 'iphone') return 'iPhone';
      if(lower === 'ipad') return 'iPad';
      if(lower === 'ipod') return 'iPod';
      return lower.charAt(0).toUpperCase() + lower.slice(1);
    }

    function normaliseModelString(candidate){
      if(!candidate) return '';
      let pretty = decodeURIComponent(candidate)
        .replace(/[-_]+/g, ' ')
        .replace(/\s+/g,' ')
        .replace(/\.(htm|html)$/i,'')
        .trim();
      if(!pretty) return '';
      const words = pretty.split(' ').filter(Boolean).map(formatModelWord);
      let result = words.join(' ');
      result = result
        .replace(/\b5g\b/gi,'5G')
        .replace(/\bUsb\b/g,'USB')
        .replace(/\bWi\s?fi\b/gi,'Wi‑Fi');
      return result.trim();
    }

    function hostToSource(url){
      try{
        const { hostname } = new URL(url);
        if(/\.ca$/i.test(hostname)) return 'MS-CA';
        return 'MS-US';
      }catch{
        return 'MS';
      }
    }

    function deriveModelName(url){
      try{
        const u = new URL(url);
        const decoded = u.pathname.split('/').filter(Boolean).map(seg => decodeURIComponent(seg));
        let candidate = '';
        for(let i = decoded.length - 1; i >= 0; i--){
          const seg = decoded[i].toLowerCase();
          if(!MODEL_SKIP_SEGMENTS.has(seg)){
            candidate = decoded[i];
            break;
          }
        }
        if(!candidate && decoded.length){
          candidate = decoded[decoded.length - 1];
        }
        const pretty = normaliseModelString(candidate || '');
        return pretty;
      }catch{
        return '';
      }
    }

    function deriveModelNames(list){
      const seen = new Set();
      const models = [];
      (list || []).forEach(url => {
        const trimmed = (url || '').trim();
        if(!trimmed) return;
        const name = deriveModelName(trimmed);
        if(!name) return;
        const source = hostToSource(trimmed);
        const key = `${name}__${source}`;
        if(seen.has(key)) return;
        seen.add(key);
        models.push({ name, source });
      });
      return models;
    }

    function renderModelChips(models){
      if(!modelChipWrap) return;
      modelChipWrap.innerHTML = '';
      if(!models || !models.length){
        modelChipWrap.hidden = true;
        localStorage.removeItem(MODEL_STORAGE_KEY);
        return;
      }
      const MAX_VISIBLE = 3;
      models.slice(0, MAX_VISIBLE).forEach(model => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'context-chip';
        chip.setAttribute('aria-pressed','false');
        chip.innerHTML = `<span>${escapeHtml(model.name)}</span><span class="context-chip__badge">${escapeHtml(model.source)}</span>`;
        modelChipWrap.appendChild(chip);
      });
      if(models.length > MAX_VISIBLE){
        const more = document.createElement('span');
        more.className = 'context-chip context-chip--more';
        more.textContent = `+${models.length - MAX_VISIBLE} more`;
        more.title = models.slice(MAX_VISIBLE).map(m => `${m.name} (${m.source})`).join(', ');
        modelChipWrap.appendChild(more);
      }
      modelChipWrap.hidden = false;
      localStorage.setItem(MODEL_STORAGE_KEY, JSON.stringify(models.slice(0, 8)));
    }

    (function restoreModelBar(){
      try {
        const stored = JSON.parse(localStorage.getItem(MODEL_STORAGE_KEY) || '[]');
        if(Array.isArray(stored) && stored.length){
          currentModels = stored;
          renderModelChips(currentModels);
        }
      } catch {
        renderModelChips([]);
      }
    })();
    if(!currentModels.length) renderModelChips([]);

    function parseMoney(maybe){
      if(!maybe) return null;
      const m = String(maybe).match(/([0-9]{1,3}(?:,[0-9]{3})*(?:\.[0-9]{2})|[0-9]+(?:\.[0-9]{2})?)/);
      if(!m) return null;
      return parseFloat(m[1].replace(/,/g,''));
    }

    function csvToRowsVisible(){
      const header = ['#','image_url','title','original','percent_off','absolute_off','final','url','source','clean_title','model','compare_price','delta','delta_pct','watchlisted'];
      const body = rows.map((r,i)=>[
        i+1,r.image_url,r.title,r.original,r.percent_off,r.absolute_off,r.final,r.url,r.source,r.clean_title,r.model,r.compare_price ?? '',r.delta ?? '',r.delta_pct ?? '', r.watchlisted ? '★' : ''
      ]);
      return [header, ...body];
    }

    function toCSV(table){
      return table.map(cols => cols.map(v => `"${String(v??'').replaceAll('"','""')}"`).join(',')).join('\n');
    }

    // --- watchlist (localStorage) ---
    function wlKey(){ return 'ms_watchlist_v8'; }
    function loadWatch(){ try{ return new Set(JSON.parse(localStorage.getItem(wlKey())||'[]')); } catch{ return new Set(); } }
    function saveWatch(set){ localStorage.setItem(wlKey(), JSON.stringify(Array.from(set))); }
    let watch = loadWatch();

    function updateStats(partial={}){
      if(statFetched && Object.prototype.hasOwnProperty.call(partial, 'fetched')){
        statFetched.textContent = partial.fetched;
      }
      if(statLastFetch && partial.lastFetch){
        statLastFetch.textContent = partial.lastFetch;
      }
      if(statVisible){
        statVisible.textContent = rows.length;
      }
      const watchSize = watch.size;
      if(statWatchlist){
        statWatchlist.textContent = watchSize;
      }
      if(heroWatchCount){
        heroWatchCount.textContent = watchSize;
      }
      if(exportWatchlistBtn){
        exportWatchlistBtn.disabled = watchSize === 0;
      }
      if(clearWatchlistBtn){
        clearWatchlistBtn.disabled = watchSize === 0;
      }
    }
    updateStats();

    // --- price memory for drop alerts ---
    function priceMemKey(){ return 'ms_last_prices_v8'; }
    function loadPriceMem(){ try{ return JSON.parse(localStorage.getItem(priceMemKey())||'{}'); } catch{ return {}; } }
    function savePriceMem(mem){ localStorage.setItem(priceMemKey(), JSON.stringify(mem)); }
    let priceMem = loadPriceMem();

    function render(){
      tbody.innerHTML = '';
      if(resultsTableContainer){
        resultsTableContainer.classList.remove('fade-in');
        void resultsTableContainer.offsetWidth;
        resultsTableContainer.classList.add('fade-in');
      }

      // inputs
      const percentOff = parseFloat(percentInput.value || '0') || 0;
      const absOff = parseFloat(absOffInput.value || '0') || 0;

      // split first, then normalize EACH token (commas were getting removed before)
      const inc = (kwInclude.value || '')
        .split(',')
        .map(s => norm(s))
        .filter(Boolean);
      const exc = (kwExclude.value || '')
        .split(',')
        .map(s => norm(s))
        .filter(Boolean);

      const minP = Number.isFinite(parseFloat(priceMin.value)) ? parseFloat(priceMin.value) : null;
      const maxP = Number.isFinite(parseFloat(priceMax.value)) ? parseFloat(priceMax.value) : null;

      // map raw -> rows
      rows = (rawItems || []).map(it => {
        const original = it.original_formatted || it.price_text || '';
        const final = it.discounted_formatted || '';
        const originalNum = parseMoney(original);
        const finalNum = parseMoney(final ?? original);
        const cleanTitle = it.title || '';
        const model = modelKey(cleanTitle);
        const cmpPrice = compareMap.get(model) ?? compareMap.get(norm(cleanTitle));
        let delta = null, deltaPct = null;
        if(finalNum != null && cmpPrice != null){
          delta = +(finalNum - cmpPrice).toFixed(2);
          deltaPct = cmpPrice ? +(((finalNum - cmpPrice)/cmpPrice)*100).toFixed(2) : null;
        }
        const watchKey = it.url || '';
        const safeWatchKey = escapeHtml(watchKey);
        const isWatched = watch.has(watchKey) || watch.has(safeWatchKey);

        return {
          url: it.url,
          site: it.site || 'mobilesentrix',
          image_url: it.image_url || '',
          title: cleanTitle,
          original: original,
          percent_off: percentOff,
          absolute_off: absOff,
          final: final || original,
          final_num: finalNum,
          original_num: originalNum,
          clean_title: cleanTitle,
          model: model,
          compare_price: cmpPrice,
          delta: delta,
          delta_pct: deltaPct,
          watchlisted: isWatched
        };
      });

      // keyword filters
      rows = rows.filter(r => {
        const t = norm((r.title || '') + ' ' + (r.url || ''));
        if (inc.length && !inc.every(k => t.includes(k))) return false;
        if (exc.length &&  exc.some(k => t.includes(k))) return false;
        return true;
      });

      // price min/max
      rows = rows.filter(r => {
        if(minP != null && (r.final_num == null || r.final_num < minP)) return false;
        if(maxP != null && (r.final_num != null && r.final_num > maxP)) return false;
        return true;
      });

      // hide dupes (by model)
      if(hideDupes.checked){
        const seen = new Set();
        rows = rows.filter(r => {
          const key = r.model || r.title.toLowerCase();
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });
      }

      // sort
      const sort = sortBy.value;
      const coll = new Intl.Collator(undefined, {numeric:true, sensitivity:'base'});
      rows.sort((a,b)=>{
        switch(sort){
          case 'final_asc': return (a.final_num??Infinity) - (b.final_num??Infinity);
          case 'final_desc': return (b.final_num??-Infinity) - (a.final_num??-Infinity);
          case 'orig_asc': return (a.original_num??Infinity) - (b.original_num??Infinity);
          case 'orig_desc': return (b.original_num??-Infinity) - (a.original_num??-Infinity);
          case 'disc_asc': return (a.percent_off||0) - (b.percent_off||0);
          case 'disc_desc': return (b.percent_off||0) - (a.percent_off||0);
          case 'title_asc': return coll.compare(a.title, b.title);
          case 'title_desc': return coll.compare(b.title, a.title);
          case 'source_asc': return coll.compare(a.site, b.site);
          case 'source_desc': return coll.compare(b.site, a.site);
          default: return 0;
        }
      });

      // optional group by model (stable within model)
      if(groupModel.checked){
        rows.sort((a,b)=>{
          const x = coll.compare(a.model, b.model);
          if(x!==0) return x;
          return coll.compare(a.title, b.title);
        });
      }

      // watchlist-only
      if(showWatchlistOnly.checked){
        rows = rows.filter(r => r.watchlisted);
      }

      const totalPages = Math.max(1, Math.ceil(rows.length / pageSize));
      if(pageSizeSelect && pageSizeSelect.value !== String(pageSize)){
        pageSizeSelect.value = String(pageSize);
      }
      if(rows.length === 0){
        currentPage = 1;
      } else if(currentPage > totalPages){
        currentPage = totalPages;
      }
      const start = (currentPage - 1) * pageSize;
      const pageRows = rows.slice(start, start + pageSize);

      // render table
      pageRows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'row-cy';
        const star = r.watchlisted ? '★' : '☆';
        const deltaTxt = (r.delta==null) ? '' : (r.delta>0 ? '+'+r.delta.toFixed(2) : r.delta.toFixed(2));
        const deltaPctTxt = (r.delta_pct==null) ? '' : (r.delta_pct>0 ? '+'+r.delta_pct.toFixed(2)+'%' : r.delta_pct.toFixed(2)+'%');
        const rawUrl = r.url || '';
        const safeUrlAttr = escapeHtml(rawUrl);
        const rawSite = r.site || '';
        const sourceInfo = formatSource(rawSite);
        const sourceLabel = sourceInfo.label;
        const safeSourceLabel = escapeHtml(sourceLabel);
        const safeSourceTitle = escapeHtml(sourceInfo.title);
        const sourceShortAttr = sourceLabel && sourceLabel.length <= 4 ? " data-short='1'" : '';
        const deltaStyle = (r.delta==null) ? '' : (r.delta<=0 ? 'style="color:#2af598;font-weight:700;"' : 'style="color:#ff6b6b;font-weight:700;"');
        tr.innerHTML = `
          <td>${start + idx + 1}</td>
          <td class="star" data-url="${safeUrlAttr}" title="Toggle watchlist">${star}</td>
          <td>${r.image_url ? `<img src="${r.image_url}" class="table-img" alt="">` : ''}</td>
          <td>${(r.title||'').replaceAll('<','&lt;')}</td>
          <td>${r.original||''}</td>
          <td>${(r.percent_off||0)}%</td>
          <td>${(r.absolute_off||0)}</td>
          <td>${r.final||''}</td>
          <td ${deltaStyle}>${deltaTxt}</td>
          <td ${deltaStyle}>${deltaPctTxt}</td>
          <td><a class="url-link" href="${safeUrlAttr}" target="_blank" rel="noopener" title="${safeUrlAttr}">Open</a></td>
          <td>${sourceLabel ? `<span class="source-chip" title="${safeSourceTitle}"${sourceShortAttr}>${safeSourceLabel}</span>` : ''}</td>
        `;
        const starCell = tr.querySelector('td.star');
        if(starCell) starCell.dataset.url = rawUrl;
        tbody.appendChild(tr);
      });

      // controls + export state
      const has = rows.length > 0;
      if(resultsEmpty) resultsEmpty.classList.toggle('d-none', has);
      if(resultsFooter){
        resultsFooter.classList.toggle('d-none', !has);
        if(prevPageBtn) prevPageBtn.disabled = currentPage <= 1;
        if(nextPageBtn) nextPageBtn.disabled = currentPage >= totalPages;
        if(pageInfo) pageInfo.textContent = has ? `Page ${Math.min(currentPage, totalPages)} of ${totalPages}` : 'Page 0 of 0';
      }
      csvBtn.disabled = xlsxBtn.disabled = copyBtn.disabled = !has;
      countBadge.textContent = `${rows.length} item${rows.length === 1 ? '' : 's'}`;
      countBadge.classList.toggle('d-none', !has);

      // export rows
      lastExportRows = rows.map(r => ({
        image_url: r.image_url, title: r.title, original: r.original, percent_off: r.percent_off, absolute_off: r.absolute_off,
        final: r.final, url: r.url, source: r.site, clean_title: r.clean_title, model: r.model,
        compare_price: r.compare_price, delta: r.delta, delta_pct: r.delta_pct, watchlisted: r.watchlisted ? '★' : ''
      }));

      // star handlers
      for(const td of document.querySelectorAll('td.star')){
        td.addEventListener('click', ()=>{
          const u = td.dataset.url;
          const safeKey = escapeHtml(u || '');
          if(watch.has(u) || watch.has(safeKey)){
            watch.delete(u);
            watch.delete(safeKey);
          } else {
            watch.delete(safeKey);
            watch.add(u);
          }
          saveWatch(watch);
          render();
        });
      }
      updateStats();
    }

    function refilter(){ currentPage = 1; render(); }

    // CSV upload (compare)
    csvUpload.addEventListener('change', async (e)=>{
      compareMap = new Map();
      const file = e.target.files[0];
      if(!file){ render(); return; }
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (res)=>{
          const rows = res.data || [];
          rows.forEach(r => {
            const title = (r.title || r.name || '').trim();
            const price = parseMoney(r.price ?? r.cost ?? r.my_price);
            const key1 = modelKey(title);
            const key2 = norm(title);
            if(title && price!=null){
              if(!compareMap.has(key1)) compareMap.set(key1, price);
              if(!compareMap.has(key2)) compareMap.set(key2, price);
            }
          });
          showAlert('success', `Loaded comparison CSV (${rows.length} rows).`);
          currentPage = 1;
          render();
        },
        error: ()=> showAlert('danger', 'Failed to parse CSV.')
      });
    });

    // Fetch
    runBtn.addEventListener('click', async ()=>{
      clearAlert();
      tbody.innerHTML = '';
      rows = [];
      csvBtn.disabled = xlsxBtn.disabled = copyBtn.disabled = true;
      countBadge.classList.add('d-none');

      const urls = (urlsTA.value || '').trim();
      if(!urls){ showAlert('warning','Please paste at least one URL.'); return; }
      const urlList = urls.split('\n').map(s => s.trim()).filter(Boolean);

      updateStats({ fetched: 0, lastFetch: 'Fetching…' });

      const payload = {
        urls,
        percent_off: parseFloat(percentInput.value || '0') || 0,
        absolute_off: parseFloat(absOffInput.value || '0') || 0,
        crawl_pagination: true,
        max_pages: 20
      };

      try{
        setLoading(true);
        const res = await fetch('/api/scrape',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('Request failed');
        const data = await res.json();
        rawItems = data.items || [];
        currentPage = 1;
        currentModels = deriveModelNames(urlList);
        renderModelChips(currentModels);

        // Price drop alerts
        const mem = loadPriceMem();
        const drop = parseFloat(dropPct.value || '10') || 10;
        let alerts = [];
        rawItems.forEach(it => {
          const url = it.url;
          const nowFinal = parseMoney(it.discounted_formatted || it.original_formatted);
          if(nowFinal==null) return;
          const prev = mem[url];
          if(prev!=null){
            const downPct = ((prev - nowFinal) / prev) * 100;
            if(downPct >= drop) alerts.push({url, title: it.title, prev, now: nowFinal, downPct: +downPct.toFixed(2)});
          }
          mem[url] = nowFinal;
        });
        savePriceMem(mem);

        render();
        updateStats({ fetched: rawItems.length, lastFetch: new Date().toLocaleString() });
        if(alerts.length){
          showAlert('success', `🔔 ${alerts.length} price drops detected (≥ ${drop}%). Check the newest results.`);
        } else {
          showAlert('success', `Fetched ${rawItems.length} item(s).`);
        }
      } catch(err){
        console.error(err);
        showAlert('danger','Error fetching. See console for details.');
        updateStats({ fetched: rawItems.length, lastFetch: 'Failed' });
        if(!rawItems.length){
          renderModelChips(currentModels);
        }
      } finally {
        setLoading(false);
      }
    });

    // Search + controls
    searchInput.addEventListener('input', refilter);
    [priceMin, priceMax, kwInclude, kwExclude, sortBy, hideDupes, groupModel, showWatchlistOnly].forEach(el => {
      el.addEventListener('input', refilter);
      el.addEventListener('change', refilter);
    });

    if(prevPageBtn){
      prevPageBtn.addEventListener('click', ()=>{
        if(currentPage > 1){
          currentPage--;
          render();
        }
      });
    }
    if(nextPageBtn){
      nextPageBtn.addEventListener('click', ()=>{
        const totalPages = Math.max(1, Math.ceil(rows.length / pageSize));
        if(currentPage < totalPages){
          currentPage++;
          render();
        }
      });
    }

    if(pageSizeSelect){
      pageSizeSelect.addEventListener('change', ()=>{
        const value = parseInt(pageSizeSelect.value, 10);
        pageSize = Number.isFinite(value) ? value : 25;
        currentPage = 1;
        localStorage.setItem(PAGE_SIZE_KEY, String(pageSize));
        render();
      });
    }

    // Exports
    $('csvBtn').addEventListener('click', ()=>{
      const table = csvToRowsVisible();
      const blob = new Blob([toCSV(table)], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'mobilesentrix_prices.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    $('xlsxBtn').addEventListener('click', async ()=>{
      try{
        const res = await fetch('/api/export/xlsx',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({rows: lastExportRows})
        });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'mobilesentrix_prices.xlsx'; a.click();
        URL.revokeObjectURL(url);
      } catch(err){
        console.error(err);
        showAlert('danger','XLSX export failed');
      }
    });

    $('copyBtn').addEventListener('click', async ()=>{
      try{
        const table = csvToRowsVisible();
        await navigator.clipboard.writeText(toCSV(table));
        showAlert('success','Copied table to clipboard (CSV format).');
      } catch(e){
        showAlert('warning','Copy failed. Use Download CSV instead.');
      }
    });

    exportWatchlistBtn.addEventListener('click', ()=>{
      const wl = Array.from(watch);
      const csv = 'url\n' + wl.map(u => `"${u.replaceAll('"','""')}"`).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'watchlist.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    if(clearWatchlistBtn){
      clearWatchlistBtn.addEventListener('click', ()=>{
        if(!watch.size) return;
        const confirmClear = window.confirm('Clear all items from your watchlist?');
        if(!confirmClear) return;
        watch.clear();
        saveWatch(watch);
        render();
        showAlert('info','Watchlist cleared.');
      });
    }

    // theme persistence
    const savedTheme = sessionStorage.getItem('cy_theme');
    if (savedTheme) document.documentElement.setAttribute('data-bs-theme', savedTheme);
    darkMode.checked = (savedTheme||'dark') === 'dark';
    darkMode.addEventListener('change', (e)=>{
      const theme = e.target.checked ? 'dark' : 'light';
      document.documentElement.setAttribute('data-bs-theme', theme);
      sessionStorage.setItem('cy_theme', theme);
    });

    render();



  </script>
</body>
</html>





